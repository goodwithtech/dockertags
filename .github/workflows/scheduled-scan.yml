name: Scan with trivy
on: [push]
jobs:
  scan:
    name: Scan via trivy
    runs-on: ubuntu-latest
    env:
      IMAGE: goodwithtech/dockle
    steps:
      - name: Fetch last tag
        id: versions
        run: |
          echo ::set-output name=trivy::$(docker run --rm goodwithtech/dockertags -contain v0.2 -limit 1 -format json aquasec/trivy | jq -r .[0].tags[0])
          echo ::set-output name=target::$(docker run --rm goodwithtech/dockertags -contain v0.2 -limit 1 -format json "$IMAGE" | jq -r .[0].tags[0])
      - name: Scan image for vulnerabilities
        run: docker run aquasec/trivy:${{ steps.versions.outputs.trivy }} --cache-dir /var/lib/trivy --exit-code 1 --no-progress $IMAGE:${{ steps.versions.output.target }}
      - name: Slack notification
        if: failure()
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          MESSAGE: 'message'
          USERNAME: scanresult
          CHANNEL: times_amachi
        uses: svikramjeet/git-actions@master